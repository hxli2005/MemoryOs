name: Deploy to Tencent Cloud

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  REGISTRY: ccr.ccs.tencentyun.com
  IMAGE_NAME: memoryos/memoryos-api

jobs:
  # ä»£ç æµ‹è¯•
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.txt
          flags: unittests
          fail_ci_if_error: false

  # æ„å»º Docker é•œåƒ
  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Tencent Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.TENCENT_CCR_USERNAME }}
          password: ${{ secrets.TENCENT_CCR_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
      url: https://${{ secrets.SERVER_DOMAIN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script_stop: true
          script: |
            set -e
            
            echo "=== å¼€å§‹éƒ¨ç½² MemoryOS ==="
            
            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /root/MemoryOs || { echo "é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }
            
            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "1. æ‹‰å–æœ€æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main
            
            # ç™»å½•å®¹å™¨é•œåƒä»“åº“
            echo "2. ç™»å½•å®¹å™¨é•œåƒä»“åº“..."
            echo "${{ secrets.TENCENT_CCR_PASSWORD }}" | docker login ${{ env.REGISTRY }} \
              -u ${{ secrets.TENCENT_CCR_USERNAME }} --password-stdin
            
            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "3. æ‹‰å–æœ€æ–°é•œåƒ..."
            docker-compose -f docker-compose.4c4g.yml pull memoryos
            
            # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨
            echo "4. åˆ›å»ºå¤‡ä»½..."
            BACKUP_IMAGE="memoryos-backup-$(date +%Y%m%d-%H%M%S)"
            docker tag memoryos-api:current "$BACKUP_IMAGE" 2>/dev/null || true
            
            # æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºï¼‰
            echo "5. æ‰§è¡Œæ»šåŠ¨æ›´æ–°..."
            docker-compose -f docker-compose.4c4g.yml up -d --no-deps --build memoryos
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "6. ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 15
            
            # å¥åº·æ£€æŸ¥
            echo "7. æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..10}; do
              if curl -f http://localhost:8080/health; then
                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
                docker-compose -f docker-compose.4c4g.yml down memoryos
                docker tag "$BACKUP_IMAGE" memoryos-api:current
                docker-compose -f docker-compose.4c4g.yml up -d memoryos
                exit 1
              fi
              echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/10)"
              sleep 3
            done
            
            # æ¸…ç†æ—§é•œåƒ
            echo "8. æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
            echo "9. æœåŠ¡è¿è¡ŒçŠ¶æ€:"
            docker-compose -f docker-compose.4c4g.yml ps
            
            echo "=== éƒ¨ç½²å®Œæˆ ==="

      - name: Verify deployment
        run: |
          echo "éªŒè¯éƒ¨ç½²ç»“æœ..."
          sleep 5
          curl -f https://${{ secrets.SERVER_DOMAIN }}/health || \
          curl -f http://${{ secrets.SERVER_HOST }}:8080/health

      - name: Notify deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha.substring(0, 7);
            const message = `ğŸš€ MemoryOS éƒ¨ç½²æˆåŠŸï¼\n\n` +
              `ğŸ“¦ ç‰ˆæœ¬: ${sha}\n` +
              `ğŸŒ ç¯å¢ƒ: Production\n` +
              `â° æ—¶é—´: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n` +
              `ğŸ‘¤ æ“ä½œè€…: ${context.actor}`;
            
            console.log(message);
            
            // å¯é€‰ï¼šå‘é€åˆ°é’‰é’‰/ä¼ä¸šå¾®ä¿¡
            // await fetch(process.env.WEBHOOK_URL, {
            //   method: 'POST',
            //   headers: { 'Content-Type': 'application/json' },
            //   body: JSON.stringify({ text: message })
            // });

      - name: Notify deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `âŒ MemoryOS éƒ¨ç½²å¤±è´¥ï¼\n\n` +
              `è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—`;
            console.error(message);

  # å›æ»šåŠŸèƒ½ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
  rollback:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: production
    steps:
      - name: Rollback deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/MemoryOs
            echo "æ‰§è¡Œå›æ»šæ“ä½œ..."
            
            # æŸ¥æ‰¾æœ€è¿‘çš„å¤‡ä»½é•œåƒ
            BACKUP_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | \
              grep "memoryos-backup" | head -n 1)
            
            if [ -z "$BACKUP_IMAGE" ]; then
              echo "âŒ æœªæ‰¾åˆ°å¤‡ä»½é•œåƒ"
              exit 1
            fi
            
            echo "å›æ»šåˆ°ç‰ˆæœ¬: $BACKUP_IMAGE"
            docker-compose -f docker-compose.4c4g.yml down memoryos
            docker tag "$BACKUP_IMAGE" memoryos-api:current
            docker-compose -f docker-compose.4c4g.yml up -d memoryos
            
            sleep 10
            curl -f http://localhost:8080/health && echo "âœ… å›æ»šæˆåŠŸ" || echo "âŒ å›æ»šå¤±è´¥"
