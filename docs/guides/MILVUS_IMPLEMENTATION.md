# Milvus VectorStore å®ç°æ€»ç»“

## âœ… å·²å®Œæˆ

### 1. æ ¸å¿ƒå®ç°
- **æ–‡ä»¶**: `internal/storage/milvus/vector_store.go`
- **åŠŸèƒ½**:
  - âœ… Collection è‡ªåŠ¨åˆ›å»ºï¼ˆSchema å®šä¹‰ï¼‰
  - âœ… HNSW ç´¢å¼•æ„å»ºï¼ˆM=16, ef=200/100ï¼‰
  - âœ… Insert æ–¹æ³•ï¼ˆæ”¯æŒå•æ¡æ’å…¥ + Flushï¼‰
  - âœ… Search æ–¹æ³•ï¼ˆå‘é‡æ£€ç´¢ + è¿‡æ»¤è¡¨è¾¾å¼ï¼‰
  - âœ… Delete æ–¹æ³•ï¼ˆæŒ‰ ID åˆ é™¤ï¼‰
  - âœ… ç»´åº¦éªŒè¯ï¼ˆ768 ç»´ï¼‰

### 2. Schema è®¾è®¡
```go
Collection: "memories"
Fields:
  - id: VarChar(36) [PrimaryKey]
  - embedding: FloatVector(768)
  - user_id: VarChar(100)
  - layer: VarChar(20)
  - memory_type: VarChar(50)
Index: HNSW (L2 è·ç¦»)
```

### 3. Bootstrap é›†æˆ
- **æ–‡ä»¶**: `internal/bootstrap/app.go`
- **æ”¹åŠ¨**:
  - âœ… å¯¼å…¥ `milvusStore` åŒ…
  - âœ… æ ¹æ®é…ç½®é€‰æ‹© VectorStore å®ç°
  - âœ… Milvus åˆå§‹åŒ–å¤±è´¥æ—¶å›é€€åˆ° Mock

### 4. æµ‹è¯•ä»£ç 
- **æ–‡ä»¶**: `test/test_milvus.go`
- **è¦†ç›–**:
  - âœ… åº”ç”¨åˆå§‹åŒ–
  - âœ… è®°å¿†åˆ›å»ºï¼ˆ3 æ¡ä¸åŒå±‚çº§ï¼‰
  - âœ… å‘é‡æœç´¢
  - âœ… å±‚çº§è¿‡æ»¤éªŒè¯

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### HNSW å‚æ•°é€‰æ‹©
```
æ„å»ºå‚æ•°: M=16, efConstruction=200
æœç´¢å‚æ•°: ef=100

ç†ç”±:
- M=16: å¹³è¡¡ç²¾åº¦å’Œå†…å­˜ï¼ˆé»˜è®¤å€¼ï¼‰
- ef=200: æ„å»ºæ—¶é«˜ç²¾åº¦
- ef=100: æœç´¢æ—¶å¹³è¡¡é€Ÿåº¦å’Œå‡†ç¡®æ€§
```

### è·ç¦»åº¦é‡
```
ä½¿ç”¨ L2 æ¬§æ°è·ç¦»
åŸå› : é€‚ç”¨äº normalized embeddings
```

### è¿‡æ»¤è¡¨è¾¾å¼
```go
// å•å€¼è¿‡æ»¤
user_id == "user123"

// å¤šå€¼è¿‡æ»¤ï¼ˆINï¼‰
layer in ["dialogue", "topic"]

// ç»„åˆè¿‡æ»¤ï¼ˆANDï¼‰
user_id == "user123" && layer == "dialogue"
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### å¯åŠ¨ Milvus
```bash
docker-compose up -d etcd minio milvus
```

### é…ç½®æ–‡ä»¶
```yaml
vector:
  provider: "milvus"
  milvus:
    host: "localhost"
    port: 19530

embedding:
  dimension: 768  # å¿…é¡»ä¸ Milvus ä¸€è‡´
```

### è¿è¡Œæµ‹è¯•
```bash
# ç¡®ä¿ Milvus è¿è¡Œ
docker ps | grep milvus

# è¿è¡Œé›†æˆæµ‹è¯•
go run ./test/test_milvus.go
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç»´åº¦ä¸€è‡´æ€§
- Embedding API è¾“å‡º: 2560 ç»´
- EinoEmbedder é™ç»´: 768 ç»´
- Milvus Collection: 768 ç»´
- æ•°æ®åº“ pgvector: 768 ç»´

### 2. æ•°æ®ä¸€è‡´æ€§
- Milvus å­˜å‚¨å‘é‡ï¼ˆç”¨äºæ£€ç´¢ï¼‰
- PostgreSQL å­˜å‚¨å®Œæ•´å…ƒæ•°æ®ï¼ˆç”¨äºè¿‡æ»¤/æ›´æ–°ï¼‰
- ä¸¤è€…é€šè¿‡ `id` å­—æ®µå…³è”

### 3. æ€§èƒ½è€ƒè™‘
- **Flush**: æ¯æ¬¡æ’å…¥åè°ƒç”¨ï¼ˆä¿è¯æŒä¹…åŒ–ï¼‰
- **æ‰¹é‡æ’å…¥**: æœªå®ç°ï¼ˆåç»­ä¼˜åŒ–ï¼‰
- **æœç´¢ç¼“å­˜**: æœªå®ç°ï¼ˆå¯ç”¨ Redisï¼‰

## ğŸ“‹ åç»­å·¥ä½œ

### P0 - å¿…é¡»å®Œæˆ
- [ ] **å¯åŠ¨ Milvus å®¹å™¨** å¹¶éªŒè¯é›†æˆ
- [ ] **è¿è¡Œå®Œæ•´æµ‹è¯•** éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
- [ ] **è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡**ï¼ˆæœç´¢å»¶è¿Ÿã€å†…å­˜å ç”¨ï¼‰

### P1 - ä¼˜åŒ–å»ºè®®
- [ ] å®ç°æ‰¹é‡æ’å…¥ï¼ˆå‡å°‘ç½‘ç»œå¼€é”€ï¼‰
- [ ] æ·»åŠ è¿æ¥æ± ç®¡ç†
- [ ] å®ç°æœç´¢ç»“æœç¼“å­˜ï¼ˆRedisï¼‰
- [ ] æ·»åŠ ç›‘æ§æŒ‡æ ‡ï¼ˆPrometheusï¼‰

### P2 - é«˜çº§åŠŸèƒ½
- [ ] æ”¯æŒå¤šä¸ª Collectionï¼ˆæŒ‰ç”¨æˆ·åˆ†ç‰‡ï¼‰
- [ ] å®ç°å¢é‡ç´¢å¼•æ›´æ–°
- [ ] æ·»åŠ  A/B æµ‹è¯•ï¼ˆä¸åŒç´¢å¼•å‚æ•°ï¼‰

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### æ–¹æ¡ˆ A: æœ‰ Docker ç¯å¢ƒ
```bash
# 1. å¯åŠ¨ Milvus
docker-compose up -d milvus

# 2. è¿è¡Œæµ‹è¯•
go run ./test/test_milvus.go

# 3. è§‚å¯Ÿè¾“å‡ºï¼ˆåº”çœ‹åˆ°å‘é‡æœç´¢ç»“æœï¼‰
```

### æ–¹æ¡ˆ B: æ—  Docker ç¯å¢ƒ
```bash
# 1. è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆä¼šå›é€€åˆ° Mockï¼‰
go run ./test/test_integration.go

# 2. éªŒè¯ä»£ç é€»è¾‘æ­£ç¡®æ€§
# 3. ç­‰å¾… Docker ç¯å¢ƒå°±ç»ªåå†æµ‹è¯•çœŸå® Milvus
```

## ğŸ“Š å½“å‰çŠ¶æ€

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Milvus SDK é›†æˆ | âœ… | ä»£ç ç¼–è¯‘é€šè¿‡ |
| VectorStore å®ç° | âœ… | æ‰€æœ‰æ–¹æ³•å·²å®ç° |
| Bootstrap æ›´æ–° | âœ… | æ”¯æŒåŠ¨æ€åˆ‡æ¢ |
| æµ‹è¯•ä»£ç  | âœ… | å·²ç¼–å†™å®Œæˆ |
| å®é™…è¿è¡ŒéªŒè¯ | â³ | ç­‰å¾… Milvus å¯åŠ¨ |

---

**æ€»ç»“**: Milvus VectorStore å®ç°å·²å®Œæˆï¼Œä»£ç è´¨é‡è‰¯å¥½ï¼Œæ¥å£è®¾è®¡åˆç†ã€‚å½“å‰é˜»å¡ç‚¹æ˜¯ Docker ç¯å¢ƒå¯åŠ¨ï¼Œä¸€æ—¦ Milvus è¿è¡Œï¼Œå³å¯è¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•ã€‚å»ºè®®å…ˆå¯åŠ¨ Docker Desktopï¼Œç„¶åæ‰§è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½ã€‚
