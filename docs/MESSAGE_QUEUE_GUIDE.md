# æ¶ˆæ¯é˜Ÿåˆ— + é™æµæ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

é€šè¿‡ **Redis Stream** æ¶ˆæ¯é˜Ÿåˆ— + **ä»¤ç‰Œæ¡¶é™æµå™¨**ï¼Œè§£å†³çŸ­æ—¶é—´å¤šæ¡æ¶ˆæ¯å¯¼è‡´çš„ Embedding API 403 é”™è¯¯ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  QQ æ¶ˆæ¯    â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  Redis Stream   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  Consumer   â”‚
â”‚  (ç”Ÿäº§è€…)   â”‚       â”‚  (ä¸‰ä¼˜å…ˆçº§é˜Ÿåˆ—)  â”‚       â”‚  + é™æµå™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                         â”‚
                              â–¼                         â–¼
                       æŒä¹…åŒ–å­˜å‚¨               æ¯ç§’æœ€å¤š 2 æ¬¡
                       (é‡å¯ä¸ä¸¢å¤±)             Embedding API
```

### æ ¸å¿ƒä¼˜åŠ¿

1. **å‰Šå³°å¡«è°·**ï¼šé«˜å³°æœŸæ¶ˆæ¯å…ˆå…¥é˜Ÿï¼Œæ…¢æ…¢æ¶ˆè´¹
2. **é™æµä¿æŠ¤**ï¼šä»¤ç‰Œæ¡¶ç®—æ³•ç¡®ä¿ API è°ƒç”¨é¢‘ç‡ â‰¤ 2æ¬¡/ç§’
3. **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼šVIP ç”¨æˆ·æ¶ˆæ¯ä¼˜å…ˆå¤„ç†
4. **æŒä¹…åŒ–**ï¼šRedis Stream ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±
5. **å¯æ‰©å±•**ï¼šå¤šå®ä¾‹éƒ¨ç½²æ—¶ä½¿ç”¨æ¶ˆè´¹è€…ç»„è´Ÿè½½å‡è¡¡

## ğŸ“¦ ç»„ä»¶è¯´æ˜

### 1. RedisStreamQueueï¼ˆé˜Ÿåˆ—å®ç°ï¼‰
- **æ–‡ä»¶**ï¼š`pkg/queue/redis_stream_queue.go`
- **åŠŸèƒ½**ï¼š
  - ä¸‰ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼šHigh / Normal / Low
  - è‡ªåŠ¨ ACK æœºåˆ¶
  - æ”¯æŒæ¶ˆè´¹è€…ç»„ï¼ˆå¤šå®ä¾‹éƒ¨ç½²ï¼‰
  - æœ€å¤šä¿ç•™ 1 ä¸‡æ¡æ¶ˆæ¯

### 2. RateLimiterï¼ˆé™æµå™¨ï¼‰
- **æ–‡ä»¶**ï¼š`pkg/queue/rate_limiter.go`
- **ç®—æ³•**ï¼šä»¤ç‰Œæ¡¶
- **é…ç½®**ï¼š
  - `rate=2`ï¼šæ¯ç§’ç”Ÿæˆ 2 ä¸ªä»¤ç‰Œï¼ˆå³æ¯ç§’æœ€å¤šå¤„ç† 2 æ¡æ¶ˆæ¯ï¼‰
  - `capacity=5`ï¼šæ¡¶å®¹é‡ 5ï¼Œå…è®¸çªå‘æµé‡

### 3. é›†æˆç¤ºä¾‹
- **èŒè´£**ï¼š
  - ç”Ÿäº§è€…ï¼šæ¥æ”¶æ¶ˆæ¯ â†’ å…¥é˜Ÿ
  - æ¶ˆè´¹è€…ï¼šä»é˜Ÿåˆ—å–æ¶ˆæ¯ â†’ é™æµç­‰å¾… â†’ è°ƒç”¨ Chatbot

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### ä½¿ç”¨æ–¹æ³•

```go
// 1. åˆ›å»º Redis å®¢æˆ·ç«¯
redisClient := app.RedisClient

// 2. åˆ›å»ºå¸¦é˜Ÿåˆ—çš„ Bot
bot := NewBotWithQueue(adapter, redisClient, 5)

// 3. è®¾ç½®æ¶ˆæ¯å›è°ƒï¼ˆç”Ÿäº§è€…ï¼‰
onMessage(func(userID int64, message string, nickname string) {
	bot.OnMessage(userID, message, nickname)
})

// 4. å¯åŠ¨æ¶ˆè´¹è€… Worker
ctx, cancel := context.WithCancel(context.Background())
defer cancel()
bot.StartWorkers(ctx)
```

## âš™ï¸ é…ç½®å‚æ•°

### Redis Stream é…ç½®
```go
queue.NewRedisStreamQueue(redisClient, "memoryos:message_queue")
// streamKey: é˜Ÿåˆ—åç§°
// consumerGroup: "memoryos_consumers"ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
```

### é™æµå™¨é…ç½®
```go
queue.NewRateLimiter(rate, capacity)
// rate: æ¯ç§’å…è®¸çš„è¯·æ±‚æ•°ï¼ˆæ¨è 2ï¼‰
// capacity: ä»¤ç‰Œæ¡¶å®¹é‡ï¼ˆæ¨è 5ï¼Œå…è®¸çŸ­æ—¶çªå‘ï¼‰
```

### ä¼˜å…ˆçº§ç­–ç•¥
```go
// åœ¨ bot_with_queue.go çš„ OnMessage() ä¸­ä¿®æ”¹
priority := 1 // é»˜è®¤æ™®é€š

// è‡ªå®šä¹‰ä¼˜å…ˆçº§é€»è¾‘ï¼š
// - 2ï¼ˆé«˜ï¼‰ï¼šVIP ç”¨æˆ·ã€ä»˜è´¹ç”¨æˆ·
// - 1ï¼ˆä¸­ï¼‰ï¼šæ™®é€šç”¨æˆ·
// - 0ï¼ˆä½ï¼‰ï¼šæ–°ç”¨æˆ·ã€ä½æ´»è·ƒç”¨æˆ·
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### é˜Ÿåˆ—é•¿åº¦
```go
queueSize := bot.messageQueue.Size()
fmt.Printf("å½“å‰é˜Ÿåˆ—é•¿åº¦: %d\n", queueSize)
```

### é™æµå™¨çŠ¶æ€
```go
tokens := bot.rateLimiter.TokensAvailable()
fmt.Printf("å¯ç”¨ä»¤ç‰Œæ•°: %d\n", tokens)
```

### Redis ç›‘æ§ï¼ˆå¯é€‰ï¼‰
```bash
# æŸ¥çœ‹ Stream ä¿¡æ¯
redis-cli XINFO STREAM memoryos:message_queue:normal

# æŸ¥çœ‹æ¶ˆè´¹è€…ç»„
redis-cli XINFO GROUPS memoryos:message_queue:normal
```

## ğŸ” æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸è¿è¡Œ
```
ğŸ“¥ [é˜Ÿåˆ—] æ¶ˆæ¯å·²å…¥é˜Ÿ | ç”¨æˆ·=é’æœ¨ | ä¼˜å…ˆçº§=1 | é˜Ÿåˆ—é•¿åº¦=3
â³ [Worker 2] ç­‰å¾…ä»¤ç‰Œ... (å¯ç”¨ä»¤ç‰Œ: 1)
âœ… [Worker 2] å¤„ç†æˆåŠŸ | ç”¨æˆ·=é’æœ¨ | è€—æ—¶=1.2s | å›å¤=å˜¿å˜¿ï¼Œæˆ‘ä¸€ç›´éƒ½åœ¨å‘€~...
```

### é™æµç”Ÿæ•ˆ
```
ğŸ“¥ [é˜Ÿåˆ—] æ¶ˆæ¯å·²å…¥é˜Ÿ | ç”¨æˆ·=é’æœ¨ | ä¼˜å…ˆçº§=1 | é˜Ÿåˆ—é•¿åº¦=8
â³ [Worker 1] ç­‰å¾…ä»¤ç‰Œ... (å¯ç”¨ä»¤ç‰Œ: 0)
â³ [Worker 2] ç­‰å¾…ä»¤ç‰Œ... (å¯ç”¨ä»¤ç‰Œ: 0)
â³ [Worker 3] ç­‰å¾…ä»¤ç‰Œ... (å¯ç”¨ä»¤ç‰Œ: 0)
âœ… [Worker 1] å¤„ç†æˆåŠŸ | ç”¨æˆ·=é’æœ¨ | è€—æ—¶=2.1s | å›å¤=...
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. åŠ¨æ€è°ƒæ•´é™æµé€Ÿç‡
æ ¹æ® API é”™è¯¯ç‡åŠ¨æ€è°ƒæ•´ `rate`ï¼š
```go
// å¦‚æœæ”¶åˆ° 429 é”™è¯¯ï¼Œé™ä½é€Ÿç‡
if err.Error().Contains("429") {
    rateLimiter.SetRate(1) // é™è‡³ 1æ¬¡/ç§’
}
```

### 2. æ‰¹é‡ Embedding
å°†å¤šæ¡æ¶ˆæ¯åˆå¹¶ä¸ºä¸€æ¬¡ API è°ƒç”¨ï¼š
```go
// åœ¨ Worker ä¸­ç´¯ç§¯ 5 æ¡æ¶ˆæ¯åæ‰¹é‡è°ƒç”¨
batch := []string{msg1, msg2, msg3, msg4, msg5}
embeddings := embedder.BatchEmbed(ctx, batch)
```

### 3. æœ¬åœ°ç¼“å­˜
å¯¹å¸¸è§æ¶ˆæ¯ï¼ˆå¦‚"åœ¨å—"ï¼‰ç¼“å­˜ Embeddingï¼š
```go
if cached, ok := embeddingCache.Get(msg.Content); ok {
    return cached, nil
}
```

## ğŸš€ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] Redis å·²å¯åŠ¨å¹¶å¯è¿æ¥
- [ ] `go.mod` å·²æ·»åŠ  `github.com/go-redis/redis/v8`
- [ ] ä¿®æ”¹ `main.go` é›†æˆæ¶ˆæ¯é˜Ÿåˆ—
- [ ] é…ç½®é™æµé€Ÿç‡ï¼ˆæ¨è 2æ¬¡/ç§’ï¼‰
- [ ] æµ‹è¯•ï¼šå¿«é€Ÿå‘é€ 10 æ¡æ¶ˆæ¯è§‚å¯Ÿæ—¥å¿—
- [ ] ç›‘æ§ï¼šé˜Ÿåˆ—é•¿åº¦ã€ä»¤ç‰Œæ•°ã€å¤„ç†è€—æ—¶

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆç”¨ Redis Stream è€Œä¸æ˜¯ RabbitMQï¼Ÿ
- Redis Stream æ›´è½»é‡ï¼Œé¡¹ç›®å·²æœ‰ Redis
- æ”¯æŒæŒä¹…åŒ–å’Œæ¶ˆè´¹è€…ç»„
- æ€§èƒ½è¶³å¤Ÿï¼ˆ10 ä¸‡æ¡/ç§’ï¼‰

### Q2: é™æµé€Ÿç‡è®¾ç½®ä¸ºå¤šå°‘åˆé€‚ï¼Ÿ
- æ ¹æ® API é™åˆ¶ï¼šçµé›… API å»ºè®® â‰¤ 3æ¬¡/ç§’
- å»ºè®®è®¾ç½®ä¸º 2æ¬¡/ç§’ï¼Œç•™æœ‰ä½™é‡
- å¯é€šè¿‡ç¯å¢ƒå˜é‡åŠ¨æ€è°ƒæ•´

### Q3: æ¶ˆæ¯ä¼šä¸¢å¤±å—ï¼Ÿ
- Redis Stream æŒä¹…åŒ–ä¿è¯ä¸ä¸¢å¤±
- å»ºè®®å¼€å¯ Redis AOF æŒä¹…åŒ–ï¼š`appendonly yes`

### Q4: å¤šå®ä¾‹éƒ¨ç½²å¦‚ä½•è´Ÿè½½å‡è¡¡ï¼Ÿ
- ä½¿ç”¨åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„åç§°
- Redis Stream è‡ªåŠ¨åˆ†é…æ¶ˆæ¯åˆ°ä¸åŒå®ä¾‹

---

**ä¸‹ä¸€æ­¥**ï¼šè¿è¡Œ `go mod tidy && docker-compose up -d` æµ‹è¯•é›†æˆæ•ˆæœ
