# Embedding API é”™è¯¯å¤„ç†ä¸é™çº§ç­–ç•¥

## é—®é¢˜æè¿°

åœ¨çŸ­æ—¶é—´å†…æ”¶åˆ°åŒä¸€ç”¨æˆ·çš„å¤šæ¡æ¶ˆæ¯æ—¶ï¼ŒQQ Bot å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```
âŒ [Worker 2] å¤„ç†å¤±è´¥: å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯å¤±è´¥: ç”Ÿæˆå‘é‡å¤±è´¥: 
error, status code: 403, status: 403 Forbidden, message: openai_error
```

### æ ¹æœ¬åŸå› 

1. **API é¢‘ç‡é™åˆ¶ï¼ˆRate Limitï¼‰**
   - Embedding API å¯¹è°ƒç”¨é¢‘ç‡æœ‰é™åˆ¶ï¼ˆå¦‚æ¯åˆ†é’Ÿ 60 æ¬¡ï¼‰
   - çŸ­æ—¶é—´å†…å¤šæ¡æ¶ˆæ¯è§¦å‘é™æµ

2. **å¹¶å‘è¯·æ±‚å†²çª**
   - å¤šä¸ª Worker åŒæ—¶è°ƒç”¨ Embedding API
   - è¶…è¿‡ API çš„å¹¶å‘é™åˆ¶

3. **ä¸´æ—¶ç½‘ç»œé”™è¯¯**
   - API æœåŠ¡ä¸´æ—¶ä¸å¯ç”¨
   - ç½‘ç»œæ³¢åŠ¨å¯¼è‡´è¯·æ±‚å¤±è´¥

---

## è§£å†³æ–¹æ¡ˆ

### âœ… å·²å®ç°çš„æ”¹è¿›

#### 1. **Embedding é‡è¯•æœºåˆ¶**

```go
func (m *Manager) embedWithRetry(ctx context.Context, text string, maxRetries int) ([]float32, error) {
    for attempt := 1; attempt <= maxRetries; attempt++ {
        embedding, err := m.embedder.Embed(ctx, text)
        if err == nil {
            return embedding, nil
        }
        
        // æ£€æµ‹ 403/429 é”™è¯¯ï¼Œé€’å¢ç­‰å¾…åé‡è¯•
        if strings.Contains(errMsg, "403") || strings.Contains(errMsg, "429") {
            waitTime := time.Duration(attempt) * 500 * time.Millisecond
            time.Sleep(waitTime)
            continue
        }
        
        // å…¶ä»–é”™è¯¯ç›´æ¥è¿”å›
        return nil, err
    }
}
```

**ç‰¹ç‚¹**ï¼š
- é»˜è®¤é‡è¯• **3 æ¬¡**
- é€’å¢ç­‰å¾…æ—¶é—´ï¼š500ms â†’ 1s â†’ 1.5s
- åªå¯¹é¢‘ç‡é™åˆ¶é”™è¯¯ï¼ˆ403/429ï¼‰é‡è¯•
- å…¶ä»–é”™è¯¯ï¼ˆå¦‚ç½‘ç»œæ–­å¼€ï¼‰ä¸é‡è¯•ï¼Œç›´æ¥é™çº§

---

#### 2. **ä¼˜é›…é™çº§å¤„ç†**

å½“ Embedding ç”Ÿæˆå¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

1. **è·³è¿‡å‘é‡å­˜å‚¨**ï¼šä¸å­˜å…¥ Milvus
2. **ä¿ç•™å…ƒæ•°æ®å­˜å‚¨**ï¼šç¡®ä¿å¯¹è¯è®°å½•ä¸ä¸¢å¤±
3. **ç»§ç»­å¯¹è¯æµç¨‹**ï¼šä¸å½±å“ç”¨æˆ·ä½“éªŒ

```go
embedding, err := m.embedWithRetry(ctx, memory.Content, 3)
if err != nil {
    // é™çº§ï¼šä»…å­˜å‚¨å…ƒæ•°æ®ï¼Œè·³è¿‡å‘é‡åº“
    fmt.Printf("âš ï¸  [é™çº§] å‘é‡ç”Ÿæˆå¤±è´¥ï¼Œä»…å­˜å‚¨å…ƒæ•°æ®: %v\n", err)
    
    if err := m.metaStore.Insert(ctx, memory); err != nil {
        return fmt.Errorf("å­˜å‚¨åˆ°å…ƒæ•°æ®åº“å¤±è´¥: %w", err)
    }
    
    return nil // æˆåŠŸä½†æ— å‘é‡
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¯¹è¯è®°å½•å§‹ç»ˆä¿å­˜åœ¨ PostgreSQL
- âœ… ç”¨æˆ·ä¸ä¼šæ”¶åˆ°"å¤„ç†å¤±è´¥"çš„é”™è¯¯
- âœ… åç»­å¯é€šè¿‡è¡¥å…¨ä»»åŠ¡ç”Ÿæˆç¼ºå¤±çš„å‘é‡

---

#### 3. **å‘é‡åº“å­˜å‚¨å¤±è´¥é™çº§**

å³ä½¿æœ‰ Embeddingï¼ŒMilvus å­˜å‚¨å¤±è´¥æ—¶ä¹Ÿä¼šé™çº§ï¼š

```go
if err := m.vectorStore.Insert(ctx, memory); err != nil {
    // å‘é‡åº“å¤±è´¥æ—¶ä¹Ÿé™çº§ï¼šè‡³å°‘ä¿è¯å…ƒæ•°æ®å­˜å‚¨æˆåŠŸ
    fmt.Printf("âš ï¸  [é™çº§] å‘é‡åº“å­˜å‚¨å¤±è´¥ï¼Œä»…å­˜å‚¨å…ƒæ•°æ®: %v\n", err)
    
    if err := m.metaStore.Insert(ctx, memory); err != nil {
        return fmt.Errorf("å­˜å‚¨åˆ°å…ƒæ•°æ®åº“å¤±è´¥: %w", err)
    }
    
    return nil
}
```

---

## æ•ˆæœéªŒè¯

### æµ‹è¯•åœºæ™¯ï¼šçŸ­æ—¶é—´å†…å‘é€ 5 æ¡æ¶ˆæ¯

**ä¹‹å‰çš„è¡Œä¸º**ï¼š
```
æ¶ˆæ¯1: âœ… å¤„ç†æˆåŠŸ
æ¶ˆæ¯2: âœ… å¤„ç†æˆåŠŸ
æ¶ˆæ¯3: âŒ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯å¤±è´¥: 403 Forbidden
æ¶ˆæ¯4: âŒ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯å¤±è´¥: 403 Forbidden
æ¶ˆæ¯5: âŒ å­˜å‚¨åŠ©æ‰‹æ¶ˆæ¯å¤±è´¥: 403 Forbidden
```

**ç°åœ¨çš„è¡Œä¸º**ï¼š
```
æ¶ˆæ¯1: âœ… å¤„ç†æˆåŠŸï¼ˆæœ‰å‘é‡ï¼‰
æ¶ˆæ¯2: âœ… å¤„ç†æˆåŠŸï¼ˆæœ‰å‘é‡ï¼‰
æ¶ˆæ¯3: âš ï¸  [é‡è¯• 1/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 500ms åé‡è¯•
       âœ… é‡è¯•æˆåŠŸï¼ˆæœ‰å‘é‡ï¼‰
æ¶ˆæ¯4: âš ï¸  [é‡è¯• 1/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 500ms åé‡è¯•
       âš ï¸  [é‡è¯• 2/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 1s åé‡è¯•
       âœ… é‡è¯•æˆåŠŸï¼ˆæœ‰å‘é‡ï¼‰
æ¶ˆæ¯5: âš ï¸  [é™çº§] å‘é‡ç”Ÿæˆå¤±è´¥ï¼Œä»…å­˜å‚¨å…ƒæ•°æ®
       âœ… å¤„ç†æˆåŠŸï¼ˆæ— å‘é‡ï¼Œä½†å¯¹è¯è®°å½•å·²ä¿å­˜ï¼‰
```

---

## æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸æµç¨‹
```
ğŸ“¨ [ç”¨æˆ·(123)] ä½ å¥½
ğŸ¯ [Worker 0] å¬å›ç­–ç•¥: session_start: é‡ç”»åƒï¼Œè½»å¯¹è¯
ğŸ’¬ [ç”¨æˆ·(123)] å›å¤: å—¨~ ä½ å¥½å‘€
```

### é‡è¯•æˆåŠŸ
```
ğŸ“¨ [ç”¨æˆ·(123)] ç¬¬äºŒæ¡æ¶ˆæ¯
âš ï¸  [é‡è¯• 1/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 500ms åé‡è¯•: error, status code: 429
ğŸ¯ [Worker 1] å¬å›ç­–ç•¥: session_start: é‡ç”»åƒï¼Œè½»å¯¹è¯
ğŸ’¬ [ç”¨æˆ·(123)] å›å¤: æ”¶åˆ°~
```

### é™çº§å¤„ç†
```
ğŸ“¨ [ç”¨æˆ·(123)] ç¬¬ä¸‰æ¡æ¶ˆæ¯
âš ï¸  [é‡è¯• 1/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 500ms åé‡è¯•: error, status code: 429
âš ï¸  [é‡è¯• 2/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 1s åé‡è¯•: error, status code: 429
âš ï¸  [é‡è¯• 3/3] Embedding API é”™è¯¯ï¼Œç­‰å¾… 1.5s åé‡è¯•: error, status code: 429
âš ï¸  [é™çº§] å‘é‡ç”Ÿæˆå¤±è´¥ï¼Œä»…å­˜å‚¨å…ƒæ•°æ®: embedding é‡è¯• 3 æ¬¡åä»å¤±è´¥
ğŸ¯ [Worker 2] å¬å›ç­–ç•¥: multi_turn: é‡å¯¹è¯ï¼Œè½»ç”»åƒ
ğŸ’¬ [ç”¨æˆ·(123)] å›å¤: å—¯å—¯
```

---

## å¯¹å¬å›çš„å½±å“

### æœ‰å‘é‡çš„è®°å¿†
- âœ… å¯ä»¥é€šè¿‡å‘é‡æ£€ç´¢å¬å›ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰
- âœ… å¯ä»¥é€šè¿‡å…ƒæ•°æ®æŸ¥è¯¢å¬å›ï¼ˆæ—¶é—´ã€ç±»å‹ç­‰ï¼‰

### æ— å‘é‡çš„è®°å¿†ï¼ˆé™çº§åï¼‰
- âŒ æ— æ³•é€šè¿‡å‘é‡æ£€ç´¢å¬å›
- âœ… ä»å¯é€šè¿‡å…ƒæ•°æ®æŸ¥è¯¢å¬å›ï¼ˆå¦‚ `RecallDialogueContext`ï¼‰
- âœ… å¯¹è¯å†å²å®Œæ•´ä¿ç•™ï¼ˆæŒ‰æ—¶é—´é¡ºåºå¯æŸ¥ï¼‰

**å½±å“æœ€å°åŒ–**ï¼š
- å¯¹è¯å±‚è®°å¿†ä¸»è¦æŒ‰ Session é¡ºåºå¬å›ï¼Œä¸ä¾èµ–å‘é‡
- è¯é¢˜å±‚å’Œç”»åƒå±‚æ‰éœ€è¦å‘é‡æ£€ç´¢
- é™çº§æ¨¡å¼ä¸‹çŸ­æœŸå¯¹è¯åŠŸèƒ½å®Œå…¨æ­£å¸¸

---

## åç»­ä¼˜åŒ–æ–¹å‘

### 1. **å‘é‡è¡¥å…¨ä»»åŠ¡ï¼ˆæ¨èï¼‰**
å®šæœŸæ£€æŸ¥ç¼ºå¤±å‘é‡çš„è®°å¿†ï¼Œè¡¥å……ç”Ÿæˆï¼š

```go
// æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
func BackfillMissingEmbeddings(ctx context.Context) {
    memories, _ := metaStore.GetMemoriesWithoutEmbedding(ctx, 100)
    for _, mem := range memories {
        embedding, err := embedder.Embed(ctx, mem.Content)
        if err == nil {
            vectorStore.Insert(ctx, mem)
        }
    }
}
```

### 2. **æœ¬åœ°ç¼“å­˜ Embedding**
å¯¹ç›¸åŒå†…å®¹é¿å…é‡å¤è°ƒç”¨ APIï¼š

```go
type EmbeddingCache struct {
    cache map[string][]float32
    mu    sync.RWMutex
}

func (c *EmbeddingCache) GetOrEmbed(ctx context.Context, text string) ([]float32, error) {
    // æ£€æŸ¥ç¼“å­˜
    if cached, exists := c.cache[text]; exists {
        return cached, nil
    }
    
    // è°ƒç”¨ API
    embedding, err := embedder.Embed(ctx, text)
    if err == nil {
        c.cache[text] = embedding
    }
    return embedding, err
}
```

### 3. **API é™æµå™¨**
åœ¨åº”ç”¨å±‚é¢æ§åˆ¶è°ƒç”¨é¢‘ç‡ï¼š

```go
type RateLimiter struct {
    limiter *rate.Limiter // æ¯åˆ†é’Ÿ 50 æ¬¡
}

func (r *RateLimiter) Embed(ctx context.Context, text string) ([]float32, error) {
    r.limiter.Wait(ctx) // ç­‰å¾…ä»¤ç‰Œ
    return embedder.Embed(ctx, text)
}
```

### 4. **æ‰¹é‡ Embedding**
åˆå¹¶å¤šä¸ªè¯·æ±‚å‡å°‘ API è°ƒç”¨ï¼š

```go
// ç­‰å¾… 100ms æˆ–ç´¯ç§¯ 10 æ¡æ¶ˆæ¯åæ‰¹é‡å¤„ç†
func BatchEmbed(ctx context.Context, texts []string) ([][]float32, error) {
    return embedder.EmbedBatch(ctx, texts)
}
```

---

## æ€»ç»“

é€šè¿‡**é‡è¯•æœºåˆ¶ + é™çº§å¤„ç†**ï¼Œç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š
- âœ… è‡ªåŠ¨åº”å¯¹ API é¢‘ç‡é™åˆ¶
- âœ… ç¡®ä¿å¯¹è¯è®°å½•ä¸ä¸¢å¤±
- âœ… ä¸å½±å“ç”¨æˆ·èŠå¤©ä½“éªŒ
- âœ… ä¸ºåç»­ä¼˜åŒ–é¢„ç•™ç©ºé—´

**æ ¸å¿ƒåŸåˆ™**ï¼šå®å¯æš‚æ—¶ç¼ºå¤±å‘é‡ï¼Œä¹Ÿä¸èƒ½è®©å¯¹è¯æµç¨‹ä¸­æ–­ã€‚
